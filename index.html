<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bird Blues & Bird Tunes Trainer v2.1</title>
<style>
:root {
  --bg:#121212;--panel:#1a1a1a;--ink:#eee;--ink-dim:#aaa;
  --accent:#ff9800;--accent2:#42a5f5;--barline:#666;--sym:#ffb733;
}
body{margin:0;background:var(--bg);color:var(--ink);font-family:'Courier New',monospace;}
h1{text-align:center;color:var(--accent);margin:16px 0;}
.controls{display:flex;flex-wrap:wrap;justify-content:center;gap:8px;margin:10px auto;}
.controls label{align-self:center}
.controls select,.controls button{background:#1e1e1e;color:var(--sym);border:1px solid var(--accent);
  padding:6px 12px;border-radius:6px;cursor:pointer;font-weight:bold;min-width:120px;transition:.15s;}
.controls select:hover,.controls button:hover{background:var(--accent);color:#000;}
.btn-secondary{border-color:var(--accent2);color:#9fd2ff;}
.btn-secondary:hover{background:var(--accent2);color:#000;}
.sheet{background:var(--panel);border:2px solid var(--accent);border-radius:10px;padding:16px;
  max-width:1100px;margin:0 auto 16px auto;overflow-x:auto;}
.row{display:grid;grid-template-columns:repeat(4,1fr);min-width:720px;}
.bar{min-height:88px;border-right:2px solid var(--barline);display:flex;flex-direction:column;
  align-items:center;justify-content:center;cursor:pointer;transition:.12s;padding:6px;}
.bar:last-child{border-right:none;}
.bar:hover{background:#222;transform:translateY(-1px);}
.chord{font-size:22px;font-weight:bold;color:var(--sym);}
.roman{font-size:12px;color:var(--ink-dim);}
.analysis{font-size:10px;color:#90caf9;margin-top:3px;display:none;}
.bebop{font-size:11px;color:#90caf9;opacity:.9;margin-top:4px;}
.legend{text-align:center;color:#ccc;font-size:12px;margin-bottom:10px;}
.fretboard-section{display:none;background:#1a1a1a;border:2px solid var(--accent);border-radius:8px;
  padding:20px;max-width:1100px;margin:30px auto;}
.fretboard-title{text-align:center;color:var(--accent);margin-bottom:15px;}
.fretboard{display:flex;flex-direction:column;gap:3px;background:#2a2a2a;padding:15px;border-radius:4px;
  overflow-x:auto;}
.string{display:flex;gap:2px;align-items:center;}
.string-label{width:30px;text-align:right;color:#888;font-size:14px;font-weight:bold;}
.fret{width:50px;height:35px;background:#3a3a3a;border:1px solid #555;display:flex;align-items:center;
  justify-content:center;font-size:12px;color:#666;text-align:center;white-space:pre-wrap;}
.fret.highlighted{font-weight:bold;}
@media print{
  body{background:#fff;color:#000}
  .controls,.legend,.fretboard-section{display:none}
  .sheet{border:none;background:#fff}
  h1{font-size:24px;text-align:left;margin-bottom:6px;color:#000}
  .chord{color:#000}.roman{color:#222}
}
</style>
</head>
<body>
<h1>ðŸŽ¶ Bird Blues & Bird Tunes Trainer v2.1</h1>

<div class="controls">
  <label for="tuneSel">Tune:</label>
  <select id="tuneSel" aria-label="Select tune"></select>
  <button id="randomTune">Random Bird Tune</button>

  <label for="keySel">Key:</label>
  <select id="keySel" aria-label="Select key">
    <option>C</option><option>F</option><option>Bb</option><option>Eb</option>
    <option>Ab</option><option>Db</option><option>Gb</option><option>B</option>
    <option>E</option><option>A</option><option>D</option><option>G</option><option>F#</option>
  </select>

  <button id="generateBtn">Generate Lead Sheet</button>
  <button id="toggleMode" class="btn-secondary">Switch to Scale Mode</button>
  <button id="toggleAnalysis" class="btn-secondary">Show Analysis Overlay</button>
  <button id="printBtn" class="btn-secondary">Print Lead Sheet</button>
</div>

<div class="legend">Click a bar to hear its root and view chord tones or scale across the fretboard.</div>

<div id="sheet" class="sheet"></div>
<div id="info" class="info"></div>

<div class="fretboard-section" id="fretboard-section">
  <div class="fretboard-title" id="fretboard-title">Select a chord to view</div>
  <div class="fretboard" id="fretboard"></div>
</div>  
<script>
/* ================================
   CORE DATA
==================================*/
const chromaticSharp = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
const chromaticFlat  = ['C','Db','D','Eb','E','F','Gb','G','Ab','A','Bb','B'];
const flatKeys = ['F','Bb','Eb','Ab','Db','Gb','Cb'];

/* Normalized index mapping for all enharmonics */
const NOTE_INDEX = {
  'C':0, 'B#':0,
  'C#':1, 'Db':1,
  'D':2,
  'D#':3, 'Eb':3,
  'E':4, 'Fb':4,
  'F':5, 'E#':5,
  'F#':6, 'Gb':6,
  'G':7,
  'G#':8, 'Ab':8,
  'A':9,
  'A#':10,'Bb':10,
  'B':11,'Cb':11
};
function indexToNote(i, key) {
  const useFlats = flatKeys.includes(key);
  const arr = useFlats ? chromaticFlat : chromaticSharp;
  return arr[(i % 12 + 12) % 12];
}
function useFlatsForKey(k){ return flatKeys.includes(k); }

/* --- interval colour map --- */
const intervalColors = {
  'R':'#ff9800','â™­2':'#00bcd4','2':'#4caf50','â™¯2':'#26c6da',
  'â™­3':'#00acc1','3':'#2196f3','4':'#9c27b0','â™¯4':'#ab47bc',
  '5':'#f44336','â™¯5':'#e57373','â™­6':'#e57373','6':'#fafafa',
  'â™­7':'#fbc02d','7':'#fff59d','9':'#4caf50','11':'#9c27b0','13':'#e0e0e0'
};
const intervalNames = {0:'R',1:'â™­2',2:'2',3:'â™­3',4:'3',5:'4',6:'â™¯4',7:'5',8:'â™­6',9:'6',10:'â™­7',11:'7'};

/* --- modes & scale patterns (semitone intervals) --- */
const modePatterns = {
  'Ionian':[0,2,4,5,7,9,11],
  'Dorian':[0,2,3,5,7,9,10],
  'Phrygian':[0,1,3,5,7,8,10],
  'Lydian':[0,2,4,6,7,9,11],
  'Mixolydian':[0,2,4,5,7,9,10],
  'Aeolian':[0,2,3,5,7,8,10],
  'Locrian':[0,1,3,5,6,8,10],
  'Major Bebop':[0,2,4,5,7,8,9,11],
  'Dominant Bebop':[0,2,4,5,7,9,10,11],
  'Minor Bebop':[0,2,3,5,7,8,10,11]
};

/* --- Bird Blues + tunes (roman or letter symbols) --- */
const birdTunes = {
  "Bird Blues": [
    ["IÎ”7","vi7","ii7","V7"],
    ["IÎ”7","IV7","I7","bII7"],
    ["ii7","V7","IÎ”7","V7"]
  ],
  "Blues for Alice": [
    ["Fmaj7","Em7b5","A7","Dm7"],
    ["Gm7","C7","F7","Bb7"],
    ["Bbm7","Eb7","Am7","D7"]
  ],
  "Now's the Time": [
    ["I7","IV7","I7","I7"],
    ["IV7","IV7","I7","VI7"],
    ["II7","V7","I7","I7"]
  ],
  "Anthropology": [
    ["IÎ”7","vi7","ii7","V7"],
    ["III7","VI7","II7","V7"],
    ["IÎ”7","III7","VI7","II7"]
  ],
  "Ornithology": [
    ["Gm7","C7","FÎ”7","A7"],
    ["Dm7","G7","CMaj7","F7"],
    ["Bm7b5","E7","Am7","D7"]
  ],
  "Donna Lee": [
    ["AbÎ”7","G7","Cm7","F7"],
    ["Bb7","EbÎ”7","A7","D7"],
    ["Gm7","C7","F7","Bb7"]
  ]
});
  /* --- Extended Parker Tunes from Tune Book --- */
Object.assign(birdTunes, {
  "Au Privave": [
    ["F7","Bb7","F7","F7"],
    ["Bb7","Bdim7","F7","D7"],
    ["Gm7","C7","F7","C7"]
  ],
  "Barbados": [
    ["F7","Bb7","F7","F7"],
    ["Bb7","Bbm7","F7","D7"],
    ["Gm7","C7","F7","C7"]
  ],
  "Bloomdido": [
    ["Bb7","Eb7","Bb7","Bb7"],
    ["Eb7","EÂ°7","Bb7","G7"],
    ["C7","F7","Bb7","Bb7"]
  ],
  "Chi Chi": [
    ["F7","Bb7","F7","F7"],
    ["Bb7","Bdim7","F7","D7"],
    ["Gm7","C7","F7","F7"]
  ],
  "Cool Blues": [
    ["Bb7","Eb7","Bb7","Bb7"],
    ["Eb7","EÂ°7","Bb7","G7"],
    ["C7","F7","Bb7","Bb7"]
  ],
  "Relaxin' at Camarillo": [
    ["F7","Bb7","F7","F7"],
    ["Bb7","Bdim7","F7","D7"],
    ["Gm7","C7","F7","C7"]
  ],
  "Moose the Mooche": [
    ["BbÎ”7","G7","C7","F7"],
    ["BbÎ”7","G7","C7","F7"],
    ["D7","G7","C7","F7"]
  ],
  "Steeplechase": [
    ["BbÎ”7","G7","C7","F7"],
    ["BbÎ”7","G7","C7","F7"],
    ["D7","G7","C7","F7"]
  ],
  "Dexterity": [
    ["BbÎ”7","G7","C7","F7"],
    ["BbÎ”7","G7","C7","F7"],
    ["D7","G7","C7","F7"]
  ],
  "Leap Frog": [
    ["BbÎ”7","G7","C7","F7"],
    ["BbÎ”7","G7","C7","F7"],
    ["D7","G7","C7","F7"]
  ],
  "Ko-Ko": [
    ["BbÎ”7","A7","D7","G7"],
    ["C7","F7","BbÎ”7","F7"],
    ["BbÎ”7","A7","D7","G7"]
  ],
  "Yardbird Suite": [
    ["CÎ”7","A7","D7","G7"],
    ["CÎ”7","A7","D7","G7"],
    ["F7","E7","A7","D7"]
  ],
  "Embraceable You": [
    ["CÎ”7","A7","Dm7","G7"],
    ["CÎ”7","A7","Dm7","G7"],
    ["F7","E7","A7","D7"]
  ],
  "My Old Flame": [
    ["EbÎ”7","C7","Fm7","Bb7"],
    ["EbÎ”7","C7","Fm7","Bb7"],
    ["Ab7","G7","C7","F7"]
  ],
  "Lover Man": [
    ["CÎ”7","A7","Dm7","G7"],
    ["CÎ”7","A7","Dm7","G7"],
    ["F7","E7","A7","D7"]
  ]
});
const tuneSel = document.getElementById('tuneSel');
Object.keys(birdTunes).forEach(t=>{let o=document.createElement('option');o.textContent=t;tuneSel.appendChild(o);});

/* ================================
   AUDIO SETUP
==================================*/
const freqBase = {'C':261.63,'C#':277.18,'Db':277.18,'D':293.66,'Eb':311.13,'E':329.63,'F':349.23,
'F#':369.99,'Gb':369.99,'G':392,'Ab':415.30,'A':440,'Bb':466.16,'A#':466.16,'B':493.88};
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
/* Make sure audio can start after first user gesture */
let audioUnlocked = false;
function unlockAudio(){
  if(audioUnlocked) return;
  const silent = audioCtx.createBufferSource();
  silent.buffer = audioCtx.createBuffer(1, 1, 22050);
  silent.connect(audioCtx.destination);
  silent.start(0);
  audioUnlocked = true;
}
document.addEventListener('pointerdown', ()=>audioCtx.resume().then(unlockAudio), { once:true });

/* ================================
   FRETFBOARD BUILD
==================================*/
const stringNotes=['E','B','G','D','A','E']; // high to low
function getNoteAtFret(open, fret, key){
  const idx = NOTE_INDEX[open];
  return indexToNote(idx + fret, key);
}
function buildFretboard(){
  const fb=document.getElementById('fretboard'); fb.innerHTML='';
  const key = keySel.value;
  stringNotes.forEach(s=>{
    const row=document.createElement('div'); row.className='string';
    const lab=document.createElement('div'); lab.className='string-label'; lab.textContent=s; row.appendChild(lab);
    for(let f=0;f<=12;f++){
      const fr=document.createElement('div'); fr.className='fret';
      const note = getNoteAtFret(s,f,key);
      fr.dataset.note = note;
      if(f===0) fr.textContent = s;
      row.appendChild(fr);
    } fb.appendChild(row);
  });
}
function clearFretboard(){document.querySelectorAll('.fret').forEach(fr=>{fr.className='fret';fr.textContent='';});}

/* ================================
   THEORY HELPERS
==================================*/
const IONIAN = [0,2,4,5,7,9,11];
const DEGREE_TO_NUM = { 'I':1,'II':2,'III':3,'IV':4,'V':5,'VI':6,'VII':7 };
const NUM_TO_ROMAN = ['I','II','III','IV','V','VI','VII'];

function majorScale(key){ // returns 7-note array
  const rootIdx = NOTE_INDEX[key];
  return IONIAN.map(i => indexToNote(rootIdx + i, key));
}

function detectOriginalKeyFromTune(tuneRows){
  // Look for a Maj7/Î”7 chord to infer I; fallback to first chord's root
  for(const row of tuneRows){
    for(const sym of row){
      const m = sym.match(/^([A-G](?:#|b)?)(.*)$/);
      if(m){
        const [_, root, rest] = m;
        if(/Î”|maj7|Maj7/i.test(rest)) return root;
      }
    }
  }
  // last resort: first letter chord root or C
  for(const row of tuneRows){
    for(const sym of row){
      const m = sym.match(/^([A-G](?:#|b)?)/);
      if(m) return m[1];
    }
  }
  return 'C';
}

function parseChordSymbol(sym, key, transposeSemis=0){
  // Return { root, displaySuffix, quality, romanDisplay }
  // 1) Roman-style e.g., "ii7", "bII7", "IÎ”7"
  const romanMatch = sym.match(/^([b#]?)(I{1,3}|IV|V|VI{0,2}|VII)(.*)$/i);
  if(romanMatch){
    const [, acc, roman, ext] = romanMatch;
    const degree = DEGREE_TO_NUM[roman.toUpperCase()];
    const isLower = roman === roman.toLowerCase();
    const accShift = acc === 'b' ? -1 : acc === '#' ? 1 : 0;
    // Diatonic degree base
    const rootOfKey = NOTE_INDEX[key];
    const baseSemis = IONIAN[degree-1];
    const absolute = rootOfKey + baseSemis + accShift + transposeSemis;
    const root = indexToNote(absolute, key);

    // quality inference
    let quality='dom7', displaySuffix='7', mode='Mixolydian';
    if(/Î”|maj/i.test(ext)) { quality='maj7'; displaySuffix='Î”7'; mode='Ionian'; }
    else if(/Â°|dim/i.test(ext)) { quality='dim7'; displaySuffix='Â°7'; mode='Locrian'; }
    else if(isLower) { quality='m7'; displaySuffix='m7'; mode='Dorian'; }

    // keep provided explicit suffix if it contains extensions like m7b5
    if(/m7b5|Ã¸/i.test(ext)){ quality='m7b5'; displaySuffix='m7b5'; mode='Locrian'; }
    if(/7/.test(ext) && quality==='maj7' && !/maj|Î”/.test(ext)){ displaySuffix='Î”7'; }

    return { root, displaySuffix, quality, romanDisplay: (acc||'')+roman.toString()+ (displaySuffix||'') , mode };
  }

  // 2) Letter-style e.g., "Fmaj7", "Bm7b5"
  const m = sym.match(/^([A-G](?:#|b)?)(.*)$/);
  if(m){
    let [, root, rest] = m;
    // apply transposition
    const idx = NOTE_INDEX[root];
    const transposedRoot = indexToNote(idx + transposeSemis, key);
    root = transposedRoot;

    // normalize quality
    let quality='dom7', displaySuffix='7', mode='Mixolydian';
    if(/Î”|maj7|Maj7/i.test(rest)){ quality='maj7'; displaySuffix='Î”7'; mode='Ionian'; }
    else if(/m7b5|Ã¸/i.test(rest)){ quality='m7b5'; displaySuffix='m7b5'; mode='Locrian'; }
    else if(/Â°7|dim7|o7/i.test(rest)){ quality='dim7'; displaySuffix='Â°7'; mode='Locrian'; }
    else if(/m(?!aj)/i.test(rest)){ quality='m7'; displaySuffix='m7'; mode='Dorian'; }
    else if(/7/.test(rest)){ quality='dom7'; displaySuffix='7'; mode='Mixolydian'; }
    else { quality='maj7'; displaySuffix='Î”7'; mode='Ionian'; }

    // roman analysis (simple)
    const scale = majorScale(key);
    const rootIdx = NOTE_INDEX[root];
    const keyIdx = NOTE_INDEX[key];
    const rel = (rootIdx - keyIdx + 12) % 12;
    let degreeIdx = IONIAN.indexOf(rel);
    let romanDisplay = '?';
    if(degreeIdx !== -1){
      const baseRoman = NUM_TO_ROMAN[degreeIdx];
      const isMinor = (quality==='m7' || quality==='m7b5');
      romanDisplay = isMinor ? baseRoman.toLowerCase() : baseRoman;
      if(quality==='maj7') romanDisplay += 'Î”';
      romanDisplay += displaySuffix.replace('Î”','').replace('Î”7','7'); // keep cleaner
    } else {
      // off-diatonic: try nearest +/-1
      if(IONIAN.includes((rel+1)%12)) romanDisplay = 'b' + NUM_TO_ROMAN[IONIAN.indexOf((rel+1)%12)] + displaySuffix;
      else if(IONIAN.includes((rel+11)%12)) romanDisplay = '#' + NUM_TO_ROMAN[IONIAN.indexOf((rel+11)%12)] + displaySuffix;
      else romanDisplay = displaySuffix;
    }
    return { root, displaySuffix, quality, romanDisplay, mode };
  }

  // Fallback
  return { root: indexToNote(NOTE_INDEX[key], key), displaySuffix:'', quality:'maj7', romanDisplay:'IÎ”', mode:'Ionian' };
}

/* ================================
   LEADSHEET RENDERING
==================================*/
const sheet=document.getElementById('sheet'), info=document.getElementById('info'), keySel=document.getElementById('keySel');
let showScaleMode=false, showAnalysis=false;

function playRoot(note){
  const osc=audioCtx.createOscillator(); const g=audioCtx.createGain();
  osc.type='sine'; osc.frequency.value=freqBase[note]||440; g.gain.value=0.15;
  osc.connect(g); g.connect(audioCtx.destination);
  const t=audioCtx.currentTime; g.gain.exponentialRampToValueAtTime(0.001,t+1);
  osc.start(t); osc.stop(t+1);
}

function getChordTones(quality,root){
  const map={
    'maj7':[0,4,7,11],
    'dom7':[0,4,7,10],
    'm7':[0,3,7,10],
    'dim7':[0,3,6,9],
    'm7b5':[0,3,6,10]
  };
  const intervals=map[quality]||map['dom7'];
  const idx=NOTE_INDEX[root];
  const degs=['R','3','5','7'];
  return intervals.map((i,n)=>({note:indexToNote(idx+i, keySel.value),degree:degs[n]}));
}

function showOnFretboard(root, chordTones, modeName){
  clearFretboard();
  const rootIdx=NOTE_INDEX[root];
  const modeInts=modePatterns[modeName]||modePatterns['Ionian'];
  document.querySelectorAll('.fret').forEach(fr=>{
    const note=fr.dataset.note;
    const noteIdx=NOTE_INDEX[note];
    if(showScaleMode){
      const intv=(noteIdx-rootIdx+12)%12;
      if(modeInts.includes(intv)){
        const lbl=intervalNames[intv]; fr.classList.add('highlighted');
        fr.style.background=intervalColors[lbl]||'#2a2a2a';
        fr.textContent=`${note}\n${lbl}`;
      }
    }else{
      const m=chordTones.find(ct=>ct.note===note);
      if(m){fr.classList.add('highlighted');
        fr.style.background=intervalColors[m.degree]||'#2a2a2a';
        fr.textContent=`${note}\n${m.degree}`;
      }
    }
  });
  document.getElementById('fretboard-section').style.display='block';
  document.getElementById('fretboard-title').textContent=
    showScaleMode?`${modeName} for ${root}`:`Chord tones for ${root}`;
}

/* --- Render the chosen tune --- */
function renderTune(name,key){
  sheet.innerHTML='';
  const tune=birdTunes[name]; if(!tune) return;

  // If tune is letter-based, compute transposition from detected original key to target key
  const containsLetterChords = tune.flat().some(sym => /^[A-G]/.test(sym));
  let transposeSemis = 0;
  if(containsLetterChords){
    const origRoot = detectOriginalKeyFromTune(tune);
    const shift = (NOTE_INDEX[key] - NOTE_INDEX[origRoot] + 12) % 12;
    transposeSemis = shift;
  }

  tune.forEach(rowChords=>{
    const row=document.createElement('div'); row.className='row';
    rowChords.forEach(sym=>{
      const parsed = parseChordSymbol(sym, key, transposeSemis);
      const bar=document.createElement('div'); bar.className='bar';
      const displayChord = `${parsed.root}${parsed.displaySuffix}`;
      const analysis=`Roman: ${parsed.romanDisplay}`;
      bar.innerHTML=`<div class='chord'>${displayChord}</div>
                     <div class='roman'>${parsed.romanDisplay}</div>
                     <div class='analysis'>${analysis}</div>`;
      bar.addEventListener('click',()=>{
        playRoot(parsed.root);
        const tones=getChordTones(parsed.quality, parsed.root);
        showOnFretboard(parsed.root,tones,parsed.mode);
      });
      row.appendChild(bar);
    });
    sheet.appendChild(row);
  });
  info.innerHTML=`<strong>${name}</strong> in <strong>${key}</strong><br><span style='color:#888'>Click a chord bar to hear and view tones.</span>`;
}

/* ================================
   EVENT HANDLERS
==================================*/
document.getElementById('generateBtn').addEventListener('click',()=>{ buildFretboard(); renderTune(tuneSel.value,keySel.value); });
document.getElementById('randomTune').addEventListener('click',()=>{
  const keys=Object.keys(birdTunes); const rnd=keys[Math.floor(Math.random()*keys.length)];
  tuneSel.value=rnd; buildFretboard(); renderTune(rnd,keySel.value);
});
document.getElementById('toggleMode').addEventListener('click',()=>{
  showScaleMode=!showScaleMode;
  document.getElementById('toggleMode').textContent=showScaleMode?'Switch to Chord Mode':'Switch to Scale Mode';
});
document.getElementById('toggleAnalysis').addEventListener('click',()=>{
  showAnalysis=!showAnalysis;
  document.querySelectorAll('.analysis').forEach(a=>a.style.display=showAnalysis?'block':'none');
});
document.getElementById('printBtn').addEventListener('click',()=>window.print());

/* --- build fretboard and default tune --- */
buildFretboard();
tuneSel.value = 'Bird Blues';
renderTune('Bird Blues','C');
</script>
</body>
</html>
